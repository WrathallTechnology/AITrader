<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AITrader Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0a0a0f;
            color: #e0e0e0;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 20px 30px;
            border-bottom: 1px solid #2a2a4a;
        }

        .header h1 {
            font-size: 24px;
            color: #fff;
        }

        .header .subtitle {
            color: #888;
            font-size: 14px;
            margin-top: 5px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #12121a;
            border: 1px solid #2a2a4a;
            border-radius: 12px;
            padding: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 14px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-value {
            font-size: 28px;
            font-weight: 600;
            color: #fff;
        }

        .positive { color: #00c853; }
        .negative { color: #ff5252; }
        .neutral { color: #ffc107; }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-running {
            background: rgba(0, 200, 83, 0.2);
            color: #00c853;
        }

        .status-paper {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .signal-card {
            background: #12121a;
            border: 1px solid #2a2a4a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .signal-symbol {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
        }

        .signal-price {
            font-size: 18px;
            color: #888;
        }

        .signal-type {
            padding: 6px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
        }

        .signal-buy {
            background: rgba(0, 200, 83, 0.2);
            color: #00c853;
        }

        .signal-sell {
            background: rgba(255, 82, 82, 0.2);
            color: #ff5252;
        }

        .signal-hold {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .indicator {
            background: #1a1a2a;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .indicator-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }

        .indicator-value {
            font-size: 16px;
            font-weight: 500;
            color: #fff;
            margin-top: 4px;
        }

        .signals-section {
            margin-top: 10px;
            padding-top: 15px;
            border-top: 1px solid #2a2a4a;
        }

        .signal-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .signal-row-label {
            color: #888;
            font-size: 14px;
        }

        .signal-row-value {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .confidence-bar {
            width: 100px;
            height: 6px;
            background: #2a2a4a;
            border-radius: 3px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .logs-container {
            background: #0a0a0f;
            border: 1px solid #2a2a4a;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }

        .log-line {
            padding: 3px 0;
            border-bottom: 1px solid #1a1a2a;
        }

        .log-line:last-child {
            border-bottom: none;
        }

        .log-info { color: #4fc3f7; }
        .log-warning { color: #ffc107; }
        .log-error { color: #ff5252; }

        .positions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .positions-table th,
        .positions-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #2a2a4a;
        }

        .positions-table th {
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
        }

        .refresh-info {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-top: 20px;
        }

        .section-title {
            font-size: 18px;
            color: #fff;
            margin-bottom: 15px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>AITrader Dashboard</h1>
        <div class="subtitle">Real-time trading bot monitoring</div>
    </div>

    <div class="container">
        <!-- Status Cards -->
        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Portfolio Value</span>
                    <span class="status-badge status-paper" id="trading-mode">Paper</span>
                </div>
                <div class="card-value" id="portfolio-value">$0.00</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">Total P&L</span>
                    <span class="status-badge status-running" id="bot-status">Running</span>
                </div>
                <div class="card-value" id="total-pnl">$0.00</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">Cash Available</span>
                </div>
                <div class="card-value" id="cash-available">$0.00</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">Open Positions</span>
                </div>
                <div class="card-value" id="positions-count">0</div>
            </div>
        </div>

        <!-- Signals Section -->
        <h2 class="section-title">Market Signals</h2>
        <div id="signals-container">
            <div class="signal-card loading">
                <p style="color: #666; text-align: center;">Loading signals...</p>
            </div>
        </div>

        <!-- Scanner Section -->
        <h2 class="section-title" style="margin-top: 30px;">Crypto Scanner</h2>
        <div class="card">
            <p style="color: #888; font-size: 12px; margin-bottom: 15px;">Auto-discovers top trading opportunities across 28+ crypto pairs</p>
            <table class="positions-table" id="scanner-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Price</th>
                        <th>24h Change</th>
                        <th>RSI</th>
                        <th>Volatility</th>
                        <th>Volume 24h</th>
                        <th>Score</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody id="scanner-table-body">
                    <tr>
                        <td colspan="8" style="text-align: center; color: #666;">Loading scanner data...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Positions Section -->
        <h2 class="section-title" style="margin-top: 30px;">Positions</h2>
        <div class="card">
            <table class="positions-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Quantity</th>
                        <th>Entry Price</th>
                        <th>Current Price</th>
                        <th>Market Value</th>
                        <th>P&L</th>
                    </tr>
                </thead>
                <tbody id="positions-table-body">
                    <tr>
                        <td colspan="6" style="text-align: center; color: #666;">No positions</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Transactions Section -->
        <h2 class="section-title" style="margin-top: 30px;">Transaction History</h2>
        <div class="card">
            <p style="color: #888; font-size: 12px; margin-bottom: 15px;">Recent buy/sell transactions with reasoning</p>
            <table class="positions-table" id="transactions-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Symbol</th>
                        <th>Action</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Value</th>
                        <th>Confidence</th>
                        <th>Reason</th>
                        <th>P&L</th>
                    </tr>
                </thead>
                <tbody id="transactions-table-body">
                    <tr>
                        <td colspan="9" style="text-align: center; color: #666;">Loading transactions...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Logs Section -->
        <h2 class="section-title" style="margin-top: 30px;">Recent Activity</h2>
        <div class="card">
            <div class="logs-container" id="logs-container">
                <p style="color: #666;">Loading logs...</p>
            </div>
        </div>

        <div class="refresh-info">
            Auto-refreshes every 30 seconds | Last updated: <span id="last-update">-</span>
        </div>
    </div>

    <script>
        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
            }).format(value);
        }

        // Format percentage
        function formatPercent(value) {
            const sign = value >= 0 ? '+' : '';
            return sign + value.toFixed(2) + '%';
        }

        // Get signal class
        function getSignalClass(type) {
            if (type === 'buy') return 'signal-buy';
            if (type === 'sell') return 'signal-sell';
            return 'signal-hold';
        }

        // Get confidence color
        function getConfidenceColor(confidence) {
            if (confidence >= 70) return '#00c853';
            if (confidence >= 50) return '#ffc107';
            return '#ff5252';
        }

        // Update status
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                if (data.status === 'running') {
                    document.getElementById('portfolio-value').textContent = formatCurrency(data.account.portfolio_value);
                    document.getElementById('cash-available').textContent = formatCurrency(data.account.cash);
                    document.getElementById('positions-count').textContent = data.positions_count;

                    const pnlEl = document.getElementById('total-pnl');
                    pnlEl.textContent = formatCurrency(data.pnl.value) + ' (' + formatPercent(data.pnl.percent) + ')';
                    pnlEl.className = 'card-value ' + (data.pnl.value >= 0 ? 'positive' : 'negative');

                    document.getElementById('trading-mode').textContent = data.paper_trading ? 'Paper' : 'Live';
                    document.getElementById('bot-status').textContent = 'Running';
                }
            } catch (error) {
                console.error('Error fetching status:', error);
                document.getElementById('bot-status').textContent = 'Error';
                document.getElementById('bot-status').className = 'status-badge';
                document.getElementById('bot-status').style.background = 'rgba(255, 82, 82, 0.2)';
                document.getElementById('bot-status').style.color = '#ff5252';
            }
        }

        // Update signals
        async function updateSignals() {
            try {
                const response = await fetch('/api/signals');
                const data = await response.json();

                const container = document.getElementById('signals-container');
                container.innerHTML = '';

                for (const signal of data.signals) {
                    if (signal.error) continue;

                    const techConf = signal.technical_signal.confidence;
                    const mlConf = signal.ml_signal.confidence;

                    const html = `
                        <div class="signal-card">
                            <div class="signal-header">
                                <div>
                                    <span class="signal-symbol">${signal.symbol}</span>
                                    <span class="signal-price">${formatCurrency(signal.current_price)}</span>
                                    <span class="${signal.change_24h >= 0 ? 'positive' : 'negative'}" style="font-size: 14px; margin-left: 10px;">
                                        ${formatPercent(signal.change_24h)} (24h)
                                    </span>
                                </div>
                            </div>

                            <div class="indicators-grid">
                                <div class="indicator">
                                    <div class="indicator-label">RSI</div>
                                    <div class="indicator-value ${signal.indicators.rsi < 30 ? 'positive' : signal.indicators.rsi > 70 ? 'negative' : ''}">${signal.indicators.rsi || '-'}</div>
                                </div>
                                <div class="indicator">
                                    <div class="indicator-label">MACD</div>
                                    <div class="indicator-value ${signal.indicators.macd > 0 ? 'positive' : 'negative'}">${signal.indicators.macd || '-'}</div>
                                </div>
                                <div class="indicator">
                                    <div class="indicator-label">Volatility</div>
                                    <div class="indicator-value">${signal.indicators.volatility ? signal.indicators.volatility + '%' : '-'}</div>
                                </div>
                                <div class="indicator">
                                    <div class="indicator-label">SMA 20</div>
                                    <div class="indicator-value">${signal.indicators.sma_20 ? formatCurrency(signal.indicators.sma_20) : '-'}</div>
                                </div>
                                <div class="indicator">
                                    <div class="indicator-label">SMA 50</div>
                                    <div class="indicator-value">${signal.indicators.sma_50 ? formatCurrency(signal.indicators.sma_50) : '-'}</div>
                                </div>
                                <div class="indicator">
                                    <div class="indicator-label">ATR</div>
                                    <div class="indicator-value">${signal.indicators.atr || '-'}</div>
                                </div>
                            </div>

                            <div class="signals-section">
                                <div class="signal-row">
                                    <span class="signal-row-label">Technical Analysis</span>
                                    <div class="signal-row-value">
                                        <div class="confidence-bar">
                                            <div class="confidence-fill" style="width: ${techConf}%; background: ${getConfidenceColor(techConf)};"></div>
                                        </div>
                                        <span style="width: 50px; text-align: right;">${techConf}%</span>
                                        <span class="signal-type ${getSignalClass(signal.technical_signal.type)}">${signal.technical_signal.type.toUpperCase()}</span>
                                    </div>
                                </div>
                                <div class="signal-row">
                                    <span class="signal-row-label">ML Prediction</span>
                                    <div class="signal-row-value">
                                        <div class="confidence-bar">
                                            <div class="confidence-fill" style="width: ${mlConf}%; background: ${getConfidenceColor(mlConf)};"></div>
                                        </div>
                                        <span style="width: 50px; text-align: right;">${mlConf}%</span>
                                        <span class="signal-type ${getSignalClass(signal.ml_signal.type)}">${signal.ml_signal.type.toUpperCase()}</span>
                                    </div>
                                </div>
                                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                    <strong>Technical:</strong> ${signal.technical_signal.reason}<br>
                                    <strong>ML:</strong> ${signal.ml_signal.reason}
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                }

                if (data.signals.length === 0) {
                    container.innerHTML = '<div class="signal-card"><p style="color: #666; text-align: center;">No signals available</p></div>';
                }
            } catch (error) {
                console.error('Error fetching signals:', error);
            }
        }

        // Update positions
        async function updatePositions() {
            try {
                const response = await fetch('/api/positions');
                const data = await response.json();

                const tbody = document.getElementById('positions-table-body');

                if (data.positions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No open positions</td></tr>';
                    return;
                }

                tbody.innerHTML = data.positions.map(p => `
                    <tr>
                        <td><strong>${p.symbol}</strong></td>
                        <td>${p.qty}</td>
                        <td>${formatCurrency(p.avg_entry_price)}</td>
                        <td>${formatCurrency(p.current_price)}</td>
                        <td>${formatCurrency(p.market_value)}</td>
                        <td class="${p.unrealized_pl >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(p.unrealized_pl)} (${formatPercent(p.unrealized_plpc)})
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error fetching positions:', error);
            }
        }

        // Update logs
        async function updateLogs() {
            try {
                const response = await fetch('/api/logs');
                const data = await response.json();

                const container = document.getElementById('logs-container');

                if (data.logs.length === 0) {
                    container.innerHTML = '<p style="color: #666;">No logs available</p>';
                    return;
                }

                container.innerHTML = data.logs.map(line => {
                    let className = '';
                    if (line.includes('INFO')) className = 'log-info';
                    else if (line.includes('WARNING')) className = 'log-warning';
                    else if (line.includes('ERROR')) className = 'log-error';
                    return `<div class="log-line ${className}">${line}</div>`;
                }).join('');

                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        }

        // Update scanner
        async function updateScanner() {
            try {
                const response = await fetch('/api/scanner');
                const data = await response.json();

                const tbody = document.getElementById('scanner-table-body');

                if (data.error) {
                    tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: #ff5252;">Error: ${data.error}</td></tr>`;
                    return;
                }

                if (!data.opportunities || data.opportunities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">No opportunities found</td></tr>';
                    return;
                }

                tbody.innerHTML = data.opportunities.map(o => {
                    const scoreColor = o.score >= 70 ? '#00c853' : o.score >= 50 ? '#ffc107' : '#888';
                    const rsiClass = o.rsi < 30 ? 'positive' : o.rsi > 70 ? 'negative' : '';
                    const changeClass = o.change_24h >= 0 ? 'positive' : 'negative';

                    return `
                        <tr>
                            <td><strong>${o.symbol}</strong></td>
                            <td>${formatCurrency(o.price)}</td>
                            <td class="${changeClass}">${formatPercent(o.change_24h)}</td>
                            <td class="${rsiClass}">${o.rsi.toFixed(1)}</td>
                            <td>${o.volatility.toFixed(1)}%</td>
                            <td>${formatVolume(o.volume_24h)}</td>
                            <td style="color: ${scoreColor}; font-weight: 600;">${o.score.toFixed(0)}</td>
                            <td style="font-size: 11px; color: #888; max-width: 200px;">${o.reason}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error fetching scanner:', error);
                document.getElementById('scanner-table-body').innerHTML =
                    '<tr><td colspan="8" style="text-align: center; color: #ff5252;">Failed to load scanner data</td></tr>';
            }
        }

        // Format volume
        function formatVolume(value) {
            if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
            if (value >= 1000) return '$' + (value / 1000).toFixed(0) + 'K';
            return '$' + value.toFixed(0);
        }

        // Update transactions
        async function updateTransactions() {
            try {
                const response = await fetch('/api/transactions');
                const data = await response.json();

                const tbody = document.getElementById('transactions-table-body');

                if (data.error) {
                    tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; color: #ff5252;">Error: ${data.error}</td></tr>`;
                    return;
                }

                if (!data.transactions || data.transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">No transactions yet</td></tr>';
                    return;
                }

                tbody.innerHTML = data.transactions.map(t => {
                    const actionClass = t.action === 'BUY' ? 'positive' : 'negative';
                    const time = new Date(t.timestamp).toLocaleString();
                    const pnlDisplay = t.pnl !== undefined
                        ? `<span class="${t.pnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(t.pnl)} (${t.pnl_pct >= 0 ? '+' : ''}${t.pnl_pct.toFixed(1)}%)</span>`
                        : '-';
                    const statusBadge = t.status === 'failed'
                        ? '<span style="color: #ff5252; font-size: 11px;"> (Failed)</span>'
                        : '';

                    return `
                        <tr>
                            <td style="font-size: 11px; white-space: nowrap;">${time}</td>
                            <td><strong>${t.symbol}</strong></td>
                            <td class="${actionClass}" style="font-weight: 600;">${t.action}${statusBadge}</td>
                            <td>${t.quantity ? t.quantity.toFixed(4) : '-'}</td>
                            <td>${t.price ? formatCurrency(t.price) : '-'}</td>
                            <td>${t.value ? formatCurrency(t.value) : '-'}</td>
                            <td>${t.confidence ? t.confidence.toFixed(0) + '%' : '-'}</td>
                            <td style="font-size: 11px; color: #888; max-width: 250px;">${t.reason || t.error || '-'}</td>
                            <td>${pnlDisplay}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error fetching transactions:', error);
                document.getElementById('transactions-table-body').innerHTML =
                    '<tr><td colspan="9" style="text-align: center; color: #ff5252;">Failed to load transactions</td></tr>';
            }
        }

        // Update all
        async function updateAll() {
            await Promise.all([
                updateStatus(),
                updateSignals(),
                updateScanner(),
                updatePositions(),
                updateTransactions(),
                updateLogs(),
            ]);
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        // Initial load
        updateAll();

        // Auto-refresh every 30 seconds
        setInterval(updateAll, 30000);
    </script>
</body>
</html>
