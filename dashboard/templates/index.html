<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AITrader Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0a0a0f;
            color: #e0e0e0;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 20px 30px;
            border-bottom: 1px solid #2a2a4a;
        }

        .header h1 {
            font-size: 24px;
            color: #fff;
        }

        .header .subtitle {
            color: #888;
            font-size: 14px;
            margin-top: 5px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #12121a;
            border: 1px solid #2a2a4a;
            border-radius: 12px;
            padding: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 14px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-value {
            font-size: 28px;
            font-weight: 600;
            color: #fff;
        }

        .positive { color: #00c853; }
        .negative { color: #ff5252; }
        .neutral { color: #ffc107; }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-running {
            background: rgba(0, 200, 83, 0.2);
            color: #00c853;
        }

        .status-paper {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .signal-card {
            background: #12121a;
            border: 1px solid #2a2a4a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .signal-symbol {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
        }

        .signal-price {
            font-size: 18px;
            color: #888;
        }

        .signal-type {
            padding: 6px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
        }

        .signal-buy {
            background: rgba(0, 200, 83, 0.2);
            color: #00c853;
        }

        .signal-sell {
            background: rgba(255, 82, 82, 0.2);
            color: #ff5252;
        }

        .signal-hold {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .indicator {
            background: #1a1a2a;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .indicator-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }

        .indicator-value {
            font-size: 16px;
            font-weight: 500;
            color: #fff;
            margin-top: 4px;
        }

        .signals-section {
            margin-top: 10px;
            padding-top: 15px;
            border-top: 1px solid #2a2a4a;
        }

        .signal-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .signal-row-label {
            color: #888;
            font-size: 14px;
        }

        .signal-row-value {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .confidence-bar {
            width: 100px;
            height: 6px;
            background: #2a2a4a;
            border-radius: 3px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .logs-container {
            background: #0a0a0f;
            border: 1px solid #2a2a4a;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }

        .log-line {
            padding: 3px 0;
            border-bottom: 1px solid #1a1a2a;
        }

        .log-line:last-child {
            border-bottom: none;
        }

        .log-info { color: #4fc3f7; }
        .log-warning { color: #ffc107; }
        .log-error { color: #ff5252; }

        .positions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .positions-table th,
        .positions-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #2a2a4a;
        }

        .positions-table th {
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
        }

        .refresh-info {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-top: 20px;
        }

        .section-title {
            font-size: 18px;
            color: #fff;
            margin-bottom: 15px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        /* Debug Tools Styles */
        .debug-btn {
            background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .debug-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 195, 247, 0.3);
        }

        .debug-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .debug-btn-secondary {
            background: #2a2a4a;
            color: #888;
        }

        .debug-btn-secondary:hover {
            background: #3a3a5a;
            color: #fff;
            box-shadow: none;
        }

        .debug-test-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: #1a1a2a;
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .debug-test-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .debug-test-pass {
            background: rgba(0, 200, 83, 0.2);
            color: #00c853;
        }

        .debug-test-fail {
            background: rgba(255, 82, 82, 0.2);
            color: #ff5252;
        }

        .debug-test-name {
            color: #fff;
            font-weight: 500;
            min-width: 200px;
        }

        .debug-test-result {
            color: #888;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>AITrader Dashboard</h1>
        <div class="subtitle">Real-time trading bot monitoring</div>
    </div>

    <div class="container">
        <!-- Status Cards -->
        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Portfolio Value</span>
                    <span class="status-badge status-paper" id="trading-mode">Paper</span>
                </div>
                <div class="card-value" id="portfolio-value">$0.00</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">Total P&L</span>
                    <span class="status-badge status-running" id="bot-status">Running</span>
                </div>
                <div class="card-value" id="total-pnl">$0.00</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">Cash Available</span>
                </div>
                <div class="card-value" id="cash-available">$0.00</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">Open Positions</span>
                </div>
                <div class="card-value" id="positions-count">0</div>
            </div>
        </div>

        <!-- Watchlist Signals Section -->
        <h2 class="section-title">Watchlist Signals</h2>
        <div class="card">
            <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                <p style="color: #888; font-size: 12px; margin: 0;">Technical & ML signals for all watched assets</p>
                <select id="signals-filter" onchange="updateSignals()" style="background: #2a2a2a; color: #fff; border: 1px solid #444; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                    <option value="all">All Assets</option>
                    <option value="crypto">Crypto Only</option>
                    <option value="stock">Stocks Only</option>
                </select>
                <span id="market-status" style="margin-left: auto; font-size: 11px; padding: 3px 8px; border-radius: 4px;"></span>
            </div>
            <table class="positions-table" id="signals-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Type</th>
                        <th>Price</th>
                        <th>24h</th>
                        <th>RSI</th>
                        <th>MACD</th>
                        <th>Technical</th>
                        <th>ML</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody id="signals-table-body">
                    <tr>
                        <td colspan="9" style="text-align: center; color: #666;">Loading signals...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Scanner Section -->
        <h2 class="section-title" style="margin-top: 30px;">Crypto Scanner</h2>
        <div class="card">
            <p style="color: #888; font-size: 12px; margin-bottom: 15px;">Auto-discovers top trading opportunities across 28+ crypto pairs</p>
            <table class="positions-table" id="scanner-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Price</th>
                        <th>24h Change</th>
                        <th>RSI</th>
                        <th>Volatility</th>
                        <th>Volume 24h</th>
                        <th>Score</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody id="scanner-table-body">
                    <tr>
                        <td colspan="8" style="text-align: center; color: #666;">Loading scanner data...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Options Scanner Section -->
        <h2 class="section-title" style="margin-top: 30px;">Options Scanner</h2>
        <div class="card">
            <p style="color: #888; font-size: 12px; margin-bottom: 15px;">Scans top stocks for options opportunities (high IV, unusual volume, strategy signals)</p>
            <table class="positions-table" id="options-scanner-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Price</th>
                        <th>Type</th>
                        <th>Score</th>
                        <th>Strategy</th>
                        <th>Spread</th>
                        <th>Confidence</th>
                        <th>Expected P/L</th>
                        <th>Rationale</th>
                    </tr>
                </thead>
                <tbody id="options-scanner-table-body">
                    <tr>
                        <td colspan="9" style="text-align: center; color: #666;">Loading options scanner...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Options Positions Section -->
        <h2 class="section-title" style="margin-top: 30px;">Options Positions</h2>
        <div class="card">
            <table class="positions-table" id="options-positions-table">
                <thead>
                    <tr>
                        <th>Contract</th>
                        <th>Underlying</th>
                        <th>Strike</th>
                        <th>Expiration</th>
                        <th>Type</th>
                        <th>Qty</th>
                        <th>Avg Cost</th>
                        <th>Value</th>
                        <th>P&L</th>
                        <th>DTE</th>
                    </tr>
                </thead>
                <tbody id="options-positions-table-body">
                    <tr>
                        <td colspan="10" style="text-align: center; color: #666;">No options positions</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Positions Section -->
        <h2 class="section-title" style="margin-top: 30px;">Stock/Crypto Positions</h2>
        <div class="card">
            <table class="positions-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Quantity</th>
                        <th>Entry Price</th>
                        <th>Current Price</th>
                        <th>Market Value</th>
                        <th>P&L</th>
                    </tr>
                </thead>
                <tbody id="positions-table-body">
                    <tr>
                        <td colspan="6" style="text-align: center; color: #666;">No positions</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Transactions Section -->
        <h2 class="section-title" style="margin-top: 30px;">Transaction History</h2>
        <div class="card">
            <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                <p style="color: #888; font-size: 12px; margin: 0;">Recent buy/sell transactions with reasoning</p>
                <select id="tx-filter" onchange="updateTransactions()" style="background: #2a2a2a; color: #fff; border: 1px solid #444; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                    <option value="all">All Types</option>
                    <option value="crypto">Crypto Only</option>
                    <option value="stock">Stocks Only</option>
                    <option value="options">Options Only</option>
                </select>
                <select id="tx-limit" onchange="updateTransactions()" style="background: #2a2a2a; color: #fff; border: 1px solid #444; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                    <option value="20">Last 20</option>
                    <option value="50">Last 50</option>
                    <option value="100">Last 100</option>
                </select>
            </div>
            <table class="positions-table" id="transactions-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Symbol</th>
                        <th>Action</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Value</th>
                        <th>Confidence</th>
                        <th>Reason</th>
                        <th>P&L</th>
                    </tr>
                </thead>
                <tbody id="transactions-table-body">
                    <tr>
                        <td colspan="10" style="text-align: center; color: #666;">Loading transactions...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Debug Tools Section -->
        <h2 class="section-title" style="margin-top: 30px;">Debug Tools</h2>
        <div class="card">
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;">
                <button onclick="runOptionsDebug()" class="debug-btn" id="debug-btn">Run Options Diagnostics</button>
                <button onclick="clearDebugPanel()" class="debug-btn debug-btn-secondary">Clear</button>
                <span id="debug-status" style="color: #888; font-size: 12px;"></span>
            </div>

            <!-- Debug Results Panel -->
            <div id="debug-results" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <h4 style="color: #fff; margin-bottom: 10px;">Test Results</h4>
                    <div id="debug-tests"></div>
                </div>
                <div id="debug-details" style="display: none;">
                    <h4 style="color: #fff; margin-bottom: 10px;">Details</h4>
                    <div class="logs-container" style="max-height: 300px;">
                        <pre id="debug-json" style="color: #4fc3f7; font-size: 11px; white-space: pre-wrap;"></pre>
                    </div>
                </div>
                <div id="debug-errors" style="display: none;">
                    <h4 style="color: #ff5252; margin-bottom: 10px;">Errors</h4>
                    <div class="logs-container" style="max-height: 200px; border-color: #ff5252;">
                        <pre id="debug-error-text" style="color: #ff5252; font-size: 11px; white-space: pre-wrap;"></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Section with Filtering -->
        <h2 class="section-title" style="margin-top: 30px;">Recent Activity</h2>
        <div class="card">
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;">
                <input type="text" id="log-filter" placeholder="Search logs..."
                    style="background: #1a1a2a; color: #fff; border: 1px solid #2a2a4a; padding: 6px 12px; border-radius: 4px; font-size: 12px; width: 200px;"
                    onkeyup="if(event.key==='Enter') filterLogs()">
                <select id="log-level" onchange="filterLogs()" style="background: #1a1a2a; color: #fff; border: 1px solid #2a2a4a; padding: 6px 12px; border-radius: 4px; font-size: 12px;">
                    <option value="all">All Levels</option>
                    <option value="INFO">INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                    <option value="DEBUG">DEBUG</option>
                </select>
                <button onclick="filterLogs()" class="debug-btn debug-btn-secondary" style="padding: 6px 12px;">Search</button>
                <button onclick="resetLogFilter()" class="debug-btn debug-btn-secondary" style="padding: 6px 12px;">Reset</button>
                <label style="margin-left: auto; display: flex; align-items: center; gap: 5px; color: #888; font-size: 12px;">
                    <input type="checkbox" id="log-auto-scroll" checked style="accent-color: #4fc3f7;">
                    Auto-scroll
                </label>
            </div>
            <div class="logs-container" id="logs-container">
                <p style="color: #666;">Loading logs...</p>
            </div>
            <div style="margin-top: 10px; display: flex; gap: 10px;">
                <span id="log-count" style="color: #666; font-size: 11px;">0 entries</span>
            </div>
        </div>

        <div class="refresh-info">
            Auto-refreshes every 30 seconds | Last updated: <span id="last-update">-</span>
        </div>
    </div>

    <script>
        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
            }).format(value);
        }

        // Format percentage
        function formatPercent(value) {
            const sign = value >= 0 ? '+' : '';
            return sign + value.toFixed(2) + '%';
        }

        // Get signal class
        function getSignalClass(type) {
            if (type === 'buy') return 'signal-buy';
            if (type === 'sell') return 'signal-sell';
            return 'signal-hold';
        }

        // Get confidence color
        function getConfidenceColor(confidence) {
            if (confidence >= 70) return '#00c853';
            if (confidence >= 50) return '#ffc107';
            return '#ff5252';
        }

        // Update status
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                if (data.status === 'running') {
                    document.getElementById('portfolio-value').textContent = formatCurrency(data.account.portfolio_value);
                    document.getElementById('cash-available').textContent = formatCurrency(data.account.cash);
                    document.getElementById('positions-count').textContent = data.positions_count;

                    const pnlEl = document.getElementById('total-pnl');
                    pnlEl.textContent = formatCurrency(data.pnl.value) + ' (' + formatPercent(data.pnl.percent) + ')';
                    pnlEl.className = 'card-value ' + (data.pnl.value >= 0 ? 'positive' : 'negative');

                    document.getElementById('trading-mode').textContent = data.paper_trading ? 'Paper' : 'Live';
                    document.getElementById('bot-status').textContent = 'Running';
                }
            } catch (error) {
                console.error('Error fetching status:', error);
                document.getElementById('bot-status').textContent = 'Error';
                document.getElementById('bot-status').className = 'status-badge';
                document.getElementById('bot-status').style.background = 'rgba(255, 82, 82, 0.2)';
                document.getElementById('bot-status').style.color = '#ff5252';
            }
        }

        // Update signals - new table format
        async function updateSignals() {
            try {
                const response = await fetch('/api/signals');
                const data = await response.json();

                const tbody = document.getElementById('signals-table-body');
                const filter = document.getElementById('signals-filter').value;
                const marketStatus = document.getElementById('market-status');

                // Update market status indicator
                if (data.market_open) {
                    marketStatus.textContent = 'Market Open';
                    marketStatus.style.background = 'rgba(0, 200, 83, 0.2)';
                    marketStatus.style.color = '#00c853';
                } else {
                    marketStatus.textContent = 'Market Closed';
                    marketStatus.style.background = 'rgba(255, 193, 7, 0.2)';
                    marketStatus.style.color = '#ffc107';
                }

                if (data.error) {
                    tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; color: #ff5252;">Error: ${data.error}</td></tr>`;
                    return;
                }

                // Filter signals by asset type
                let signals = data.signals || [];
                if (filter !== 'all') {
                    signals = signals.filter(s => s.asset_type === filter);
                }

                if (signals.length === 0) {
                    const message = filter === 'stock' && !data.market_open
                        ? 'Stock market closed - no stock signals available'
                        : 'No signals available';
                    tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; color: #666;">${message}</td></tr>`;
                    return;
                }

                // Asset type badge colors
                const typeColors = {
                    'crypto': { bg: 'rgba(255, 152, 0, 0.2)', color: '#ff9800' },
                    'stock': { bg: 'rgba(76, 175, 80, 0.2)', color: '#4caf50' },
                };

                tbody.innerHTML = signals.map(s => {
                    if (s.error) return '';

                    const changeClass = s.change_24h >= 0 ? 'positive' : 'negative';
                    const rsiClass = s.indicators.rsi < 30 ? 'positive' : s.indicators.rsi > 70 ? 'negative' : '';
                    const macdClass = s.indicators.macd > 0 ? 'positive' : 'negative';

                    const typeStyle = typeColors[s.asset_type] || { bg: 'rgba(128, 128, 128, 0.2)', color: '#888' };
                    const typeBadge = `<span style="background: ${typeStyle.bg}; color: ${typeStyle.color}; padding: 2px 6px; border-radius: 4px; font-size: 10px; text-transform: uppercase;">${s.asset_type}</span>`;

                    // Technical signal badge
                    const techType = s.technical_signal.type;
                    const techConf = s.technical_signal.confidence;
                    const techClass = techType === 'buy' ? 'positive' : techType === 'sell' ? 'negative' : 'neutral';
                    const techBadge = `<span class="${techClass}" style="font-weight: 600;">${techType.toUpperCase()}</span> <span style="color: #888; font-size: 11px;">${techConf}%</span>`;

                    // ML signal badge
                    const mlType = s.ml_signal.type;
                    const mlConf = s.ml_signal.confidence;
                    const mlClass = mlType === 'buy' ? 'positive' : mlType === 'sell' ? 'negative' : 'neutral';
                    const mlBadge = mlType !== 'N/A'
                        ? `<span class="${mlClass}" style="font-weight: 600;">${mlType.toUpperCase()}</span> <span style="color: #888; font-size: 11px;">${mlConf}%</span>`
                        : '<span style="color: #666;">-</span>';

                    // Combine reasons, prefer technical for display
                    const reason = s.technical_signal.reason || s.ml_signal.reason || '-';

                    return `
                        <tr>
                            <td><strong>${s.symbol}</strong></td>
                            <td>${typeBadge}</td>
                            <td>${formatCurrency(s.current_price)}</td>
                            <td class="${changeClass}">${formatPercent(s.change_24h)}</td>
                            <td class="${rsiClass}">${s.indicators.rsi || '-'}</td>
                            <td class="${macdClass}">${s.indicators.macd ? s.indicators.macd.toFixed(4) : '-'}</td>
                            <td>${techBadge}</td>
                            <td>${mlBadge}</td>
                            <td style="font-size: 11px; color: #888; max-width: 200px;">${reason}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error fetching signals:', error);
                document.getElementById('signals-table-body').innerHTML =
                    '<tr><td colspan="9" style="text-align: center; color: #ff5252;">Failed to load signals</td></tr>';
            }
        }

        // Update positions
        async function updatePositions() {
            try {
                const response = await fetch('/api/positions');
                const data = await response.json();

                const tbody = document.getElementById('positions-table-body');

                if (data.positions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No open positions</td></tr>';
                    return;
                }

                tbody.innerHTML = data.positions.map(p => `
                    <tr>
                        <td><strong>${p.symbol}</strong></td>
                        <td>${p.qty}</td>
                        <td>${formatCurrency(p.avg_entry_price)}</td>
                        <td>${formatCurrency(p.current_price)}</td>
                        <td>${formatCurrency(p.market_value)}</td>
                        <td class="${p.unrealized_pl >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(p.unrealized_pl)} (${formatPercent(p.unrealized_plpc)})
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error fetching positions:', error);
            }
        }

        // Update logs
        async function updateLogs() {
            try {
                const response = await fetch('/api/logs');
                const data = await response.json();

                const container = document.getElementById('logs-container');

                if (data.logs.length === 0) {
                    container.innerHTML = '<p style="color: #666;">No logs available</p>';
                    return;
                }

                container.innerHTML = data.logs.map(line => {
                    let className = '';
                    if (line.includes('INFO')) className = 'log-info';
                    else if (line.includes('WARNING')) className = 'log-warning';
                    else if (line.includes('ERROR')) className = 'log-error';
                    return `<div class="log-line ${className}">${line}</div>`;
                }).join('');

                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        }

        // Update scanner
        async function updateScanner() {
            try {
                const response = await fetch('/api/scanner');
                const data = await response.json();

                const tbody = document.getElementById('scanner-table-body');

                if (data.error) {
                    tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: #ff5252;">Error: ${data.error}</td></tr>`;
                    return;
                }

                if (!data.opportunities || data.opportunities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">No opportunities found</td></tr>';
                    return;
                }

                tbody.innerHTML = data.opportunities.map(o => {
                    const scoreColor = o.score >= 70 ? '#00c853' : o.score >= 50 ? '#ffc107' : '#888';
                    const rsiClass = o.rsi < 30 ? 'positive' : o.rsi > 70 ? 'negative' : '';
                    const changeClass = o.change_24h >= 0 ? 'positive' : 'negative';

                    return `
                        <tr>
                            <td><strong>${o.symbol}</strong></td>
                            <td>${formatCurrency(o.price)}</td>
                            <td class="${changeClass}">${formatPercent(o.change_24h)}</td>
                            <td class="${rsiClass}">${o.rsi.toFixed(1)}</td>
                            <td>${o.volatility.toFixed(1)}%</td>
                            <td>${formatVolume(o.volume_24h)}</td>
                            <td style="color: ${scoreColor}; font-weight: 600;">${o.score.toFixed(0)}</td>
                            <td style="font-size: 11px; color: #888; max-width: 200px;">${o.reason}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error fetching scanner:', error);
                document.getElementById('scanner-table-body').innerHTML =
                    '<tr><td colspan="8" style="text-align: center; color: #ff5252;">Failed to load scanner data</td></tr>';
            }
        }

        // Format volume
        function formatVolume(value) {
            if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
            if (value >= 1000) return '$' + (value / 1000).toFixed(0) + 'K';
            return '$' + value.toFixed(0);
        }

        // Update options scanner
        async function updateOptionsScanner() {
            try {
                const response = await fetch('/api/options-scanner');
                const data = await response.json();

                const tbody = document.getElementById('options-scanner-table-body');

                if (data.error) {
                    tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; color: #ff5252;">Error: ${data.error}</td></tr>`;
                    return;
                }

                if (!data.opportunities || data.opportunities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">No options opportunities found (market may be closed)</td></tr>';
                    return;
                }

                tbody.innerHTML = data.opportunities.map(o => {
                    const scoreColor = o.score >= 70 ? '#00c853' : o.score >= 50 ? '#ffc107' : '#888';
                    const signal = o.signal;
                    const hasSignal = signal !== null;

                    // Format expected P/L
                    let plDisplay = '-';
                    if (hasSignal && signal.expected_profit !== null && signal.max_loss !== null) {
                        plDisplay = `<span class="positive">+${formatCurrency(signal.expected_profit)}</span> / <span class="negative">${formatCurrency(signal.max_loss)}</span>`;
                    }

                    // Format opportunity type nicely
                    const typeDisplay = o.opportunity_type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

                    return `
                        <tr>
                            <td><strong>${o.symbol}</strong></td>
                            <td>${formatCurrency(o.underlying_price)}</td>
                            <td><span style="background: rgba(79, 195, 247, 0.2); color: #4fc3f7; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${typeDisplay}</span></td>
                            <td style="color: ${scoreColor}; font-weight: 600;">${o.score}</td>
                            <td>${hasSignal ? signal.strategy : '-'}</td>
                            <td>${hasSignal ? signal.spread_type.replace(/_/g, ' ') : '-'}</td>
                            <td>${hasSignal ? signal.confidence + '%' : '-'}</td>
                            <td style="font-size: 11px;">${plDisplay}</td>
                            <td style="font-size: 11px; color: #888; max-width: 250px;">${hasSignal ? signal.rationale : (o.details ? JSON.stringify(o.details).substring(0, 100) : '-')}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error fetching options scanner:', error);
                document.getElementById('options-scanner-table-body').innerHTML =
                    '<tr><td colspan="9" style="text-align: center; color: #ff5252;">Failed to load options scanner</td></tr>';
            }
        }

        // Update options positions
        async function updateOptionsPositions() {
            try {
                const response = await fetch('/api/options-positions');
                const data = await response.json();

                const tbody = document.getElementById('options-positions-table-body');

                if (data.error && !data.positions) {
                    tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; color: #ff5252;">Error: ${data.error}</td></tr>`;
                    return;
                }

                if (!data.positions || data.positions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #666;">No options positions</td></tr>';
                    return;
                }

                tbody.innerHTML = data.positions.map(p => {
                    const pnlClass = p.unrealized_pnl >= 0 ? 'positive' : 'negative';
                    const typeClass = p.option_type === 'call' ? 'positive' : 'negative';
                    const dteWarning = p.days_to_expiration <= 7 ? 'color: #ff5252; font-weight: 600;' : '';

                    return `
                        <tr>
                            <td style="font-size: 11px;"><strong>${p.symbol}</strong></td>
                            <td>${p.underlying}</td>
                            <td>${formatCurrency(p.strike)}</td>
                            <td>${p.expiration}</td>
                            <td class="${typeClass}" style="text-transform: uppercase;">${p.option_type}</td>
                            <td>${p.quantity}</td>
                            <td>${formatCurrency(p.avg_cost)}</td>
                            <td>${p.market_value ? formatCurrency(p.market_value) : '-'}</td>
                            <td class="${pnlClass}">${p.unrealized_pnl ? formatCurrency(p.unrealized_pnl) : '-'}</td>
                            <td style="${dteWarning}">${p.days_to_expiration}d</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error fetching options positions:', error);
                document.getElementById('options-positions-table-body').innerHTML =
                    '<tr><td colspan="10" style="text-align: center; color: #666;">No options positions</td></tr>';
            }
        }

        // Update transactions
        async function updateTransactions() {
            try {
                const response = await fetch('/api/transactions');
                const data = await response.json();

                const tbody = document.getElementById('transactions-table-body');
                const filter = document.getElementById('tx-filter').value;
                const limit = parseInt(document.getElementById('tx-limit').value);

                if (data.error) {
                    tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; color: #ff5252;">Error: ${data.error}</td></tr>`;
                    return;
                }

                if (!data.transactions || data.transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #666;">No transactions yet</td></tr>';
                    return;
                }

                // Filter transactions
                let filtered = data.transactions;
                if (filter !== 'all') {
                    filtered = filtered.filter(t => {
                        const assetType = t.asset_type || (t.action && t.action.startsWith('OPTIONS') ? 'options' : 'unknown');
                        return assetType === filter;
                    });
                }

                // Apply limit
                filtered = filtered.slice(0, limit);

                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #666;">No transactions match filter</td></tr>';
                    return;
                }

                // Asset type badge colors
                const typeColors = {
                    'crypto': { bg: 'rgba(255, 152, 0, 0.2)', color: '#ff9800' },
                    'stock': { bg: 'rgba(76, 175, 80, 0.2)', color: '#4caf50' },
                    'options': { bg: 'rgba(156, 39, 176, 0.2)', color: '#9c27b0' },
                };

                tbody.innerHTML = filtered.map(t => {
                    const actionClass = t.action === 'BUY' || t.action.includes('BUY') ? 'positive' : 'negative';
                    const time = new Date(t.timestamp).toLocaleString();
                    const pnlDisplay = t.pnl !== undefined
                        ? `<span class="${t.pnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(t.pnl)} (${t.pnl_pct >= 0 ? '+' : ''}${t.pnl_pct.toFixed(1)}%)</span>`
                        : '-';
                    const statusBadge = t.status === 'failed'
                        ? '<span style="color: #ff5252; font-size: 11px;"> (Failed)</span>'
                        : '';

                    // Determine asset type
                    let assetType = t.asset_type || 'unknown';
                    if (assetType === 'unknown' && t.action && t.action.startsWith('OPTIONS')) assetType = 'options';
                    const typeStyle = typeColors[assetType] || { bg: 'rgba(128, 128, 128, 0.2)', color: '#888' };
                    const typeBadge = `<span style="background: ${typeStyle.bg}; color: ${typeStyle.color}; padding: 2px 6px; border-radius: 4px; font-size: 10px; text-transform: uppercase;">${assetType}</span>`;

                    return `
                        <tr>
                            <td style="font-size: 11px; white-space: nowrap;">${time}</td>
                            <td>${typeBadge}</td>
                            <td><strong>${t.symbol}</strong></td>
                            <td class="${actionClass}" style="font-weight: 600;">${t.action}${statusBadge}</td>
                            <td>${t.quantity ? t.quantity.toFixed(4) : '-'}</td>
                            <td>${t.price ? formatCurrency(t.price) : '-'}</td>
                            <td>${t.value ? formatCurrency(t.value) : '-'}</td>
                            <td>${t.confidence ? t.confidence.toFixed(0) + '%' : '-'}</td>
                            <td style="font-size: 11px; color: #888; max-width: 250px;">${t.reason || t.error || '-'}</td>
                            <td>${pnlDisplay}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error fetching transactions:', error);
                document.getElementById('transactions-table-body').innerHTML =
                    '<tr><td colspan="10" style="text-align: center; color: #ff5252;">Failed to load transactions</td></tr>';
            }
        }

        // Update all
        async function updateAll() {
            await Promise.all([
                updateStatus(),
                updateSignals(),
                updateScanner(),
                updateOptionsScanner(),
                updateOptionsPositions(),
                updatePositions(),
                updateTransactions(),
                updateLogs(),
            ]);
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        // Debug functions
        async function runOptionsDebug() {
            const btn = document.getElementById('debug-btn');
            const status = document.getElementById('debug-status');
            const results = document.getElementById('debug-results');
            const tests = document.getElementById('debug-tests');
            const details = document.getElementById('debug-details');
            const errors = document.getElementById('debug-errors');

            btn.disabled = true;
            btn.textContent = 'Running...';
            status.textContent = 'Running diagnostics...';
            results.style.display = 'none';

            try {
                const response = await fetch('/api/options-debug');
                const data = await response.json();

                results.style.display = 'block';

                // Render test results
                if (data.tests && data.tests.length > 0) {
                    tests.innerHTML = data.tests.map(t => `
                        <div class="debug-test-item">
                            <div class="debug-test-icon ${t.passed ? 'debug-test-pass' : 'debug-test-fail'}">
                                ${t.passed ? '✓' : '✗'}
                            </div>
                            <span class="debug-test-name">${t.name}</span>
                            <span class="debug-test-result">${t.result}</span>
                        </div>
                    `).join('');

                    // Summary
                    const summary = data.summary;
                    const summaryColor = summary.all_passed ? '#00c853' : '#ff5252';
                    status.innerHTML = `<span style="color: ${summaryColor}; font-weight: 600;">${summary.passed}/${summary.total} tests passed</span>`;
                } else {
                    tests.innerHTML = '<p style="color: #666;">No test results</p>';
                }

                // Show details (chain sample, contracts, etc.)
                const detailData = {};
                if (data.chain_sample) detailData.chain_sample = data.chain_sample;
                if (data.suitable_contracts) detailData.suitable_contracts = data.suitable_contracts;
                if (data.scanner_results) detailData.scanner_results = data.scanner_results;

                if (Object.keys(detailData).length > 0) {
                    details.style.display = 'block';
                    document.getElementById('debug-json').textContent = JSON.stringify(detailData, null, 2);
                } else {
                    details.style.display = 'none';
                }

                // Show errors if any
                if (data.errors && data.errors.length > 0) {
                    errors.style.display = 'block';
                    document.getElementById('debug-error-text').textContent = data.errors.join('\n\n');
                } else {
                    errors.style.display = 'none';
                }

            } catch (error) {
                status.innerHTML = `<span style="color: #ff5252;">Error: ${error.message}</span>`;
                tests.innerHTML = `<p style="color: #ff5252;">Failed to run diagnostics: ${error.message}</p>`;
                results.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Run Options Diagnostics';
            }
        }

        function clearDebugPanel() {
            document.getElementById('debug-results').style.display = 'none';
            document.getElementById('debug-status').textContent = '';
        }

        // Log filtering functions
        let currentLogFilter = '';
        let currentLogLevel = 'all';

        async function filterLogs() {
            currentLogFilter = document.getElementById('log-filter').value;
            currentLogLevel = document.getElementById('log-level').value;
            await updateLogsFiltered();
        }

        function resetLogFilter() {
            document.getElementById('log-filter').value = '';
            document.getElementById('log-level').value = 'all';
            currentLogFilter = '';
            currentLogLevel = 'all';
            updateLogs();
        }

        async function updateLogsFiltered() {
            try {
                const filter = encodeURIComponent(currentLogFilter);
                const level = currentLogLevel;
                const url = `/api/logs/filter?lines=200&filter=${filter}&level=${level}`;

                const response = await fetch(url);
                const data = await response.json();

                const container = document.getElementById('logs-container');
                const countEl = document.getElementById('log-count');

                if (data.logs.length === 0) {
                    container.innerHTML = '<p style="color: #666;">No logs match your filter</p>';
                    countEl.textContent = '0 entries';
                    return;
                }

                container.innerHTML = data.logs.map(line => {
                    let className = '';
                    if (line.includes('INFO')) className = 'log-info';
                    else if (line.includes('WARNING')) className = 'log-warning';
                    else if (line.includes('ERROR')) className = 'log-error';
                    else if (line.includes('DEBUG')) className = 'log-info';

                    // Highlight search term
                    let displayLine = line;
                    if (currentLogFilter) {
                        const regex = new RegExp(`(${currentLogFilter})`, 'gi');
                        displayLine = line.replace(regex, '<mark style="background: #ffc107; color: #000; padding: 0 2px;">$1</mark>');
                    }

                    return `<div class="log-line ${className}">${displayLine}</div>`;
                }).join('');

                countEl.textContent = `${data.count} entries` + (data.filter ? ` matching "${data.filter}"` : '');

                // Auto-scroll if enabled
                if (document.getElementById('log-auto-scroll').checked) {
                    container.scrollTop = container.scrollHeight;
                }
            } catch (error) {
                console.error('Error filtering logs:', error);
            }
        }

        // Override default updateLogs to respect filters
        async function updateLogs() {
            if (currentLogFilter || currentLogLevel !== 'all') {
                await updateLogsFiltered();
                return;
            }

            try {
                const response = await fetch('/api/logs');
                const data = await response.json();

                const container = document.getElementById('logs-container');
                const countEl = document.getElementById('log-count');

                if (data.logs.length === 0) {
                    container.innerHTML = '<p style="color: #666;">No logs available</p>';
                    countEl.textContent = '0 entries';
                    return;
                }

                container.innerHTML = data.logs.map(line => {
                    let className = '';
                    if (line.includes('INFO')) className = 'log-info';
                    else if (line.includes('WARNING')) className = 'log-warning';
                    else if (line.includes('ERROR')) className = 'log-error';
                    return `<div class="log-line ${className}">${line}</div>`;
                }).join('');

                countEl.textContent = `${data.logs.length} entries`;

                // Auto-scroll if enabled
                if (document.getElementById('log-auto-scroll').checked) {
                    container.scrollTop = container.scrollHeight;
                }
            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        }

        // Initial load
        updateAll();

        // Auto-refresh every 30 seconds
        setInterval(updateAll, 30000);
    </script>
</body>
</html>
